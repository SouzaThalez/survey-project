<!-- Renderiza 1..N provas; mantém o mesmo layout/estilo para cada bloco -->
<div class="answer-page" *ngIf="exams?.length; else notFound">
  <!-- Um .paper por prova (ordem do storage/grupo) -->
  <div class="paper" *ngFor="let e of exams; let i = index">
    <h1 class="title">{{ e.examName || 'Prova' }}</h1>

    <p class="disclaimer">
      Antes de enviar este formulário, leia atentamente as orientações da prova abaixo.
      Após o envio, a nota será final e não poderá ser alterada.
    </p>

    <mat-divider></mat-divider>

    <div class="case-block">
      <div class="required">Regras e orientações</div>
      <div class="case-text">
        <ng-container *ngIf="e.examRules">
          <span class="rules-text">{{ e.examRules }}</span>
        </ng-container>
      </div>
    </div>

    <div class="case-block">
      <h2 class="case-title">Caso clínico</h2>
      <p class="case-text">{{ e.clinicalCase }}</p>
    </div>

    <!-- Formulário de respostas DA PROVA i -->
    <form [formGroup]="forms[i]" class="answers-form" *ngIf="e.questions?.length">
      <!-- Cabeçalhos das colunas (baseados na 1ª questão) -->
      <div class="grid header-row" [ngStyle]="{'--cols': (e.questions?.[0]?.options?.length ?? 3)}">
        <div class="cell qcell header"></div>
        <div class="cell ocell header" *ngFor="let h of optionHeaders(i)">{{ h }}</div>
      </div>

      <!-- Linhas das questões -->
      <div class="grid body-rows" [ngStyle]="{'--cols': (e.questions?.[0]?.options?.length ?? 3)}">
        <ng-container *ngFor="let q of e.questions; let j = index">
          <div class="cell qcell">
            <div class="qindex">{{ j + 1 }}.</div>
            <div class="qtext">{{ q.text }}</div>
          </div>

          <!-- opções como radios -->
          <mat-radio-group class="row-radios" [formControl]="selectionsArray(i).at(j)">
            <div class="cell ocell" *ngFor="let opt of q.options; let k = index">
              <mat-radio-button [value]="k"></mat-radio-button>
            </div>
          </mat-radio-group>
        </ng-container>
      </div>

      <!-- Rodapé/Total da prova i (sem botão individual) -->
      <div class="footer-line">
        <div class="totals">
          <strong>Nota total:</strong>
          <span>{{ selectedTotal(i) }} pontos</span>
        </div>
        <!-- Sem ações por prova -->
      </div>
    </form>
  </div>

  <!-- Footer global: somatório de todas as provas + botão único de envio -->
  <div class="global-footer">
    <div class="summary">
      <div class="summary-title">Resumo das provas</div>
      <div class="summary-line" *ngFor="let e of exams; let i = index">
        <span class="label">{{ e.examName || ('Prova ' + (i + 1)) }}:</span>
        <span class="value">{{ selectedTotal(i) }} pts</span>
      </div>
    </div>

    <div class="grand-total">
      <div class="label">Somatório geral</div>
      <div class="value">{{ overallTotal() }} pts</div>
    </div>

    <div class="actions">
      <button
        mat-flat-button
        color="primary"
        class="submit-all-btn"
        (click)="submitAll()"
        [disabled]="hasInvalidForms()"
      >
        Enviar respostas de todas as provas
        <mat-icon>send</mat-icon>
      </button>
      <div class="hint" *ngIf="hasInvalidForms()">
        Complete as questões pendentes para enviar.
      </div>
    </div>
  </div>
</div>

<!-- Fallback: não encontrado -->
<ng-template #notFound>
  <div class="answer-page">
    <div class="paper">
      <h2>Prova não encontrada</h2>
      <p>Verifique o link recebido.</p>
      <button mat-stroked-button color="primary" routerLink="/private/nova-prova">Criar nova prova</button>
    </div>
  </div>
</ng-template>
