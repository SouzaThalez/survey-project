<div class="answer-page">
  <div class="paper">
    <h1 class="title">Resultado das provas</h1>

    <p class="disclaimer">
      Esta página lista apenas as provas com pelo menos um envio. Você pode chegar aqui pelo menu
      “Resultados prova” ou após enviar suas respostas.
    </p>

    <mat-divider></mat-divider>

    <!-- Estado vazio -->
    <div class="empty" *ngIf="loaded && !cards.length">
      <p>Nenhuma prova finalizada encontrada.</p>
      <a mat-stroked-button color="primary" routerLink="/private/nova-prova">
        Criar nova prova
      </a>
    </div>

    <!-- Lista de cartões (simples ou compostos) -->
    <div class="results" *ngIf="cards.length">
      <div class="exam-card" *ngFor="let c of cards; trackBy: trackByCard">

        <div class="header-line">
          <div class="titles">
            <h2 class="exam-name">{{ cardTitle(c) }}</h2>

            <div class="meta">
              <span class="chip">
                <mat-icon>event</mat-icon>
                criada em {{ createdAtChip(c) }}
              </span>

              <!-- Número de questões -->
              <span class="chip">
                <mat-icon>quiz</mat-icon>
                {{ cardQuestionsCount(c) }} questão(ões)
              </span>

              <!-- Valor máximo -->
              <span class="chip">
                <mat-icon>score</mat-icon>
                máximo {{ c.stats.max }} pts
              </span>

              <!-- Only for composite: how many exams -->
              <span class="chip" *ngIf="c.isComposite">
                <mat-icon>layers</mat-icon>
                {{ c.exams.length }} prova(s)
              </span>

              <span class="chip" *ngIf="c.stats.lastAt">
                <mat-icon>schedule</mat-icon>
                último envio {{ c.stats.lastAt | date:'short' }}
              </span>
            </div>
          </div>

          <div class="actions">
            <!-- Abrir link público:
                 - Prova simples: shareUrl da prova
                 - Prova composta: usa o primeiro shareUrl do grupo (mantém layout) -->
            <a *ngIf="!c.isComposite"
               mat-stroked-button color="primary"
               [href]="c.exam.shareUrl" target="_blank" rel="noopener">
              <mat-icon>link</mat-icon>
              Abrir link público
            </a>
            <a *ngIf="c.isComposite && c.exams[0]?.shareUrl"
               mat-stroked-button color="primary"
               [href]="c.exams[0].shareUrl" target="_blank" rel="noopener">
              <mat-icon>link</mat-icon>
              Abrir link público (1ª)
            </a>

            <!-- Responder novamente:
                 - Prova simples: examId
                 - Prova composta: groupId -->
            <a *ngIf="!c.isComposite"
               mat-button color="primary"
               routerLink="/private/responder-prova"
               [queryParams]="{ examId: c.exam.id }">
              Responder novamente
            </a>
            <a *ngIf="c.isComposite"
               mat-button color="primary"
               routerLink="/private/responder-prova"
               [queryParams]="{ groupId: c.groupId }">
              Responder novamente
            </a>
          </div>
        </div>

        <!-- Linha de estatísticas (3 blocos) -->
        <div class="stats-row">
          <div class="stat">
            <div class="label">Envios</div>
            <div class="value">{{ c.stats.count }}</div>
          </div>
          <div class="stat">
            <div class="label">Valor da prova</div>
            <div class="value">{{ c.stats.max }}</div>
          </div>
          <div class="stat">
            <div class="label">Número de questões</div>
            <div class="value">{{ cardQuestionsCount(c) }}</div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <!-- Submissões -->
        <!-- PROVA SIMPLES -->
        <div class="subs" *ngIf="!c.isComposite">
          <div class="sub" *ngFor="let s of c.submissions; trackBy: trackBySubSimple">
            <div class="left">
              <mat-icon>person</mat-icon>
              <div class="s-meta">
                <div class="date">Enviado em {{ s.submittedAt | date:'short' }}</div>
              </div>
            </div>
            <div class="right">
              <div class="score">
                <strong>{{ s.total }}</strong> / {{ c.stats.max }}
                <span class="pct">({{ percent(s.total, c.stats.max) }})</span>
              </div>

              <button mat-stroked-button color="primary" (click)="printSubmission(c.exam, s)">
                <mat-icon>print</mat-icon>
                Imprimir PDF
              </button>
            </div>
          </div>
        </div>

        <!-- PROVA COMPOSTA -->
        <div class="subs" *ngIf="c.isComposite">
          <div class="sub" *ngFor="let s of c.submissions; trackBy: trackBySubComposite">
            <div class="left">
              <mat-icon>group</mat-icon>
              <div class="s-meta">
                <div class="date">Enviado em {{ s.submittedAt | date:'short' }}</div>
              </div>
            </div>
            <div class="right">
              <div class="score">
                <strong>{{ s.total }}</strong> / {{ c.stats.max }}
                <span class="pct">({{ percent(s.total, c.stats.max) }})</span>
              </div>

              <button mat-stroked-button color="primary" (click)="printSubmissionGroup(c, s)">
                <mat-icon>print</mat-icon>
                Imprimir PDF (todas)
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>
